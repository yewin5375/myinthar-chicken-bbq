<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º - Premium Store</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --dark: #121212; --orange: #ff6b00; --bg: #f8f9fa; }
        body { font-family: 'Pyidaungsu', sans-serif; background: var(--bg); margin: 0; overflow-x: hidden; }

        /* Side Sidebar Menu */
        .sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: var(--dark); transition: 0.3s; z-index: 2001; padding-top: 60px; color: white; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        .sidebar.active { left: 0; }
        .sidebar-item { padding: 15px 25px; border-bottom: 1px solid #333; cursor: pointer; display: block; text-decoration: none; color: white; font-size: 15px; }
        .sidebar-item:hover { background: #1a1a1a; color: var(--gold); }
        .admin-link { position: absolute; bottom: 0; width: 100%; background: #000; color: var(--gold); border-top: 1px solid var(--gold); padding: 20px 25px; box-sizing: border-box; }

        /* Header */
        .header { background: var(--dark); color: white; padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .burger { font-size: 24px; cursor: pointer; color: var(--gold); margin-right: 15px; }
        
        .container { max-width: 600px; margin: auto; padding: 15px; padding-bottom: 100px; }
        .section { display: none; }
        .section.active { display: block; }

        /* Cards & UI */
        .card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .btn-main { background: var(--dark); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
        .status-tag { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .pending { background: #fff3cd; color: #856404; }
        .cooking { background: #d1ecf1; color: #0c5460; }
        .done { background: #d4edda; color: #155724; }

        /* Overlay */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .overlay.active { display: block; }

        /* Voucher Template (Hidden) */
        #voucher-capture { position: absolute; left: -9999px; background: white; width: 350px; padding: 30px; border: 1px solid #000; text-align: center; }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-item" onclick="showPage('customer')">ğŸ— Menu (á€™á€¾á€¬á€šá€°á€›á€”á€º)</div>
    <div class="sidebar-item" onclick="showPage('tracking')">ğŸ“ Order Tracking (á€¡á€á€¼á€±á€¡á€”á€±á€…á€…á€ºá€›á€”á€º)</div>
    <div class="sidebar-item" onclick="showPage('history')">ğŸ“œ á€™á€¾á€¬á€šá€°á€™á€¾á€¯á€™á€¾á€á€ºá€á€™á€ºá€¸</div>
    <div class="sidebar-item admin-link" onclick="showPage('admin')">âš™ï¸ Admin Dashboard</div>
</div>

<div class="header">
    <div class="burger" onclick="toggleSidebar()">â˜°</div>
    <div style="font-weight:bold; letter-spacing:1px;">MYIN THAR ROAST</div>
</div>

<div class="container">
    <div id="customer" class="section active">
        <h3 style="color: var(--orange);">ğŸ”¥ Best Sellers</h3>
        <div id="customer-menu-list"></div>
    </div>

    <div id="tracking" class="section">
        <div class="card">
            <h3>ğŸ“ Track Your Order</h3>
            <p style="font-size:13px; color:#666;">á€á€„á€·á€º Order ID á€€á€­á€¯ á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€¼á€®á€¸ á€¡á€á€¼á€±á€¡á€”á€±á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹</p>
            <input type="number" id="track-id-input" placeholder="Order ID (á€¥á€•á€™á€¬ - 15)">
            <button class="btn-main" style="background:var(--orange);" onclick="trackOrder()">Track Now</button>
            <div id="track-result" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="history" class="section">
        <h3>ğŸ“œ á€™á€¾á€¬á€šá€°á€á€²á€·á€á€™á€»á€¾á€…á€¬á€›á€„á€ºá€¸</h3>
        <div id="history-list"></div>
    </div>

    <div id="admin" class="section">
        <div class="card" style="background:var(--dark); color:white;">
            <h3>ğŸ“¦ á€á€€á€ºá€œá€¬á€á€±á€¬ á€¡á€±á€¬á€ºá€’á€«á€™á€»á€¬á€¸</h3>
            <div id="admin-orders-list"></div>
        </div>
        
        <div class="card">
            <h3>â• á€™á€®á€”á€°á€¸á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€›á€”á€º</h3>
            <input type="text" id="adm-name" placeholder="á€¡á€™á€Šá€º">
            <input type="number" id="adm-price" placeholder="á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸">
            <input type="number" id="adm-stock" placeholder="Stock">
            <select id="adm-cat">
                <option value="single">á€›á€­á€¯á€¸á€›á€­á€¯á€¸</option>
                <option value="10000_set">áá€á€±á€¬á€„á€ºá€¸á€á€”á€º Set</option>
                <option value="20000_set">á‚á€á€±á€¬á€„á€ºá€¸á€á€”á€º Set</option>
            </select>
            <input type="file" id="adm-file" accept="image/*">
            <button class="btn-main" onclick="handleSaveItem()">Save Menu Item</button>
        </div>
    </div>
</div>

<div id="voucher-capture">
    <h2 style="margin:0;">MYIN THAR ROAST</h2>
    <p>Premium BBQ & Chicken</p>
    <hr>
    <p><b>Order ID:</b> #<span id="v-id"></span></p>
    <p><b>Customer:</b> <span id="v-name"></span></p>
    <div id="v-items" style="text-align:left; margin:20px 0;"></div>
    <hr>
    <h3>Total: <span id="v-total"></span> MMK</h3>
    <p style="font-size:12px;">á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€•á€«á€á€Šá€º! á€‘á€•á€ºá€™á€¶á€™á€¾á€¬á€šá€°á€›á€”á€º á€–á€­á€á€ºá€á€±á€«á€ºá€•á€«á€á€Šá€ºá‹</p>
</div>

<audio id="notiSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    const SB_URL = "https://iogpnvljnhsxuzzdltpb.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZ3BudmxqbmhzeHV6emRsdHBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NTk2MDYsImV4cCI6MjA4MjMzNTYwNn0.Kxy3QW1gq-J-tzUF2fxQd0l989Wr7BI2uRTbWDTNL6k";
    const _supabase = window.supabase.createClient(SB_URL, SB_KEY);

    // Sidebar & Navigation
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
    }

    function showPage(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        toggleSidebar();
        if(id === 'admin') fetchAdminOrders();
        if(id === 'customer') fetchMenu();
        window.scrollTo(0,0);
    }

    // ğŸ“ Tracking Logic
    async function trackOrder() {
        const id = document.getElementById('track-id-input').value;
        const { data, error } = await _supabase.from('orders').select('*').eq('id', id).single();
        const res = document.getElementById('track-result');
        if(data) {
            res.innerHTML = `
                <div class="card" style="border-left: 5px solid var(--orange);">
                    <h4>Status: <span class="status-tag ${data.status}">${data.status}</span></h4>
                    <p><b>á€•á€…á€¹á€…á€Šá€ºá€¸á€…á€¬á€›á€„á€ºá€¸:</b> ${data.items}</p>
                    <p><b>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:</b> ${data.total} MMK</p>
                    <button class="btn-main" onclick="downloadVoucher(${data.id})">ğŸ“¥ Download Invoice (Image)</button>
                </div>`;
        } else {
            res.innerHTML = "<p style='color:red;'>á€¡á€±á€¬á€ºá€’á€« ID á€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€”á€±á€•á€«á€á€Šá€ºá‹</p>";
        }
    }

    // ğŸ§¾ Voucher Image Download
    async function downloadVoucher(id) {
        const { data } = await _supabase.from('orders').select('*').eq('id', id).single();
        document.getElementById('v-id').innerText = data.id;
        document.getElementById('v-name').innerText = data.customer_name;
        document.getElementById('v-items').innerText = data.items;
        document.getElementById('v-total').innerText = data.total;

        const capture = document.getElementById('voucher-capture');
        html2canvas(capture).then(canvas => {
            const link = document.createElement('a');
            link.download = `Voucher_Order_${id}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    // ğŸ”” Realtime Notification for Admin
    _supabase.channel('orders_realtime').on('postgres_changes', { event: 'INSERT', table: 'orders' }, payload => {
        document.getElementById('notiSound').play();
        alert("ğŸš¨ á€¡á€±á€¬á€ºá€’á€«á€¡á€á€…á€º á€›á€±á€¬á€€á€ºá€œá€¬á€•á€«á€•á€¼á€®!");
        if(document.getElementById('admin').classList.contains('active')) fetchAdminOrders();
    }).subscribe();

    // Admin Functions
    async function fetchAdminOrders() {
        const { data } = await _supabase.from('orders').select('*').order('created_at', {ascending: false}).limit(10);
        document.getElementById('admin-orders-list').innerHTML = data.map(o => `
            <div style="padding:15px; border-bottom:1px solid #333;">
                <b>#${o.id} - ${o.customer_name}</b> <span class="status-tag ${o.status}">${o.status}</span><br>
                <small>${o.items}</small><br>
                <div style="margin-top:10px;">
                    <button onclick="updateStatus(${o.id}, 'cooking')" style="background:orange; border:none; padding:5px 10px; border-radius:5px;">á€€á€„á€ºá€”á€±á€á€Šá€º</button>
                    <button onclick="updateStatus(${o.id}, 'done')" style="background:green; border:none; padding:5px 10px; border-radius:5px; color:white;">á€•á€¼á€®á€¸á€•á€¼á€®</button>
                </div>
            </div>
        `).join('');
    }

    async function updateStatus(id, newStatus) {
        await _supabase.from('orders').update({ status: newStatus }).eq('id', id);
        fetchAdminOrders();
    }

    // Menu Loader
    async function fetchMenu() {
        const { data } = await _supabase.from('menu_items').select('*').order('created_at', {ascending: false});
        document.getElementById('customer-menu-list').innerHTML = data.map(item => `
            <div class="card">
                <img src="${item.image_url || 'https://via.placeholder.com/400'}" style="width:100%; height:150px; object-fit:cover; border-radius:12px;">
                <h4 style="margin:10px 0 5px 0;">${item.name}</h4>
                <div style="color:var(--orange); font-weight:bold;">${item.price.toLocaleString()} MMK</div>
                <button class="btn-main" style="margin-top:10px;" onclick="alert('á€™á€¾á€¬á€šá€°á€™á€¾á€¯á€…á€”á€…á€ºá€á€­á€¯á€·...')">ğŸ›’ á€™á€¾á€¬á€šá€°á€™á€Šá€º</button>
            </div>
        `).join('');
    }

    window.onload = fetchMenu;
</script>
</body>
</html>
