<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT Roast - Professional Admin</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        :root { --primary: #FF6B35; --secondary: #7360F2; --bg: #F8FAFC; --card: #FFFFFF; --text: #1E293B; --danger: #EF4444; --success: #10B981; }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 100px; }
        
        .header { padding: 20px; background: white; border-radius: 0 0 30px 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .search-bar { background: #F1F5F9; border-radius: 15px; padding: 10px 15px; display: flex; align-items: center; margin-top: 15px; }
        .search-bar input { background: none; border: none; outline: none; width: 100%; margin-left: 10px; font-family: inherit; font-size: 14px; }

        .container { padding: 20px; display: none; animation: fadeIn 0.4s ease; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .order-card { background: white; border-radius: 20px; padding: 18px; margin-bottom: 15px; border: 1px solid #F1F5F9; box-shadow: 0 5px 15px rgba(0,0,0,0.02); }
        .stat-card { padding: 15px; border-radius: 20px; color: white; }

        .premium-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .premium-table th { text-align: left; font-size: 11px; color: #94A3B8; padding: 5px 0; border-bottom: 1px solid #eee; }
        .premium-table td { padding: 8px 0; font-size: 13px; font-weight: 600; }

        /* Status Tabs */
        .tab-group { display: flex; background: #eee; padding: 5px; border-radius: 15px; margin-bottom: 20px; }
        .tab-btn { flex: 1; border: none; padding: 10px; border-radius: 12px; cursor: pointer; background: transparent; font-weight: 600; transition: 0.3s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 25px; padding: 25px; max-height: 80vh; overflow-y: auto; }

        /* Nav Bar */
        .nav-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: #1E293B; height: 70px; border-radius: 25px; display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .nav-item { color: #94A3B8; font-size: 20px; cursor: pointer; padding: 12px; border-radius: 50%; transition: .3s; position: relative; }
        .nav-item.active { color: white; background: var(--primary); transform: translateY(-5px); }
        .dot { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; display: none; }

        .btn { border: none; padding: 10px 18px; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
    </style>
</head>
<body>

<audio id="notiSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">MT Roast <small style="font-size:12px; color:var(--primary)">Admin</small></h2>
        <button class="btn" style="background:#eee;" onclick="requestNotificationPermission()">
            <i class="fas fa-bell"></i>
        </button>
    </div>
    <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" id="mainSearch" placeholder="Search orders, names, phones..." onkeyup="universalSearch()">
    </div>
</div>

<div id="dash-view" class="container active">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
        <div class="stat-card" style="background: var(--primary);">
            <small>FINISHED REVENUE</small><h2 id="st-total-rev">0 K</h2>
        </div>
        <div class="stat-card" style="background: var(--secondary);">
            <small>TOTAL ORDERS</small><h2 id="st-total-ord">0</h2>
        </div>
    </div>
    <h3>Quick Actions</h3>
    <button class="btn btn-success" style="width:100%;" onclick="exportToExcel()">Download Sales Report (CSV)</button>
</div>

<div id="order-view" class="container">
    <div class="tab-group">
        <button class="tab-btn active" onclick="loadOrdersByStatus(1, this)">Pending</button>
        <button class="tab-btn" onclick="loadOrdersByStatus(2, this)">Cooking</button>
        <button class="tab-btn" onclick="loadOrdersByStatus(3, this)">Finished</button>
    </div>
    <div id="order-list"></div>
</div>

<div id="customer-view" class="container">
    <h3>Customer List</h3>
    <div id="customer-list"></div>
</div>

<div id="voucherModal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center;">VOUCHER DETAILS</h3>
        <hr>
        <div id="voucher-data"></div>
        <button class="btn" style="width:100%; margin-top:20px; background:#eee;" onclick="closeModal('voucherModal')">Close</button>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="switchTab('dash', 0)"><i class="fas fa-chart-pie"></i></div>
    <div class="nav-item" onclick="switchTab('order', 1)"><i class="fas fa-receipt"></i><div id="dot-order" class="dot"></div></div>
    <div class="nav-item" onclick="switchTab('customer', 2)"><i class="fas fa-users"></i></div>
</nav>

    <script>
        // Supabase Configuration
const SB_URL = "https://iogpnvljnhsxuzzdltpb.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZ3BudmxqbmhzeHV6emRsdHBiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Njc1OTYwNiwiZXhwIjoyMDgyMzM1NjA2fQ.rNXHHO8PKO58ZXR4Eqzi6Bl0vzCIwH24jiwOVwbVPoc";
const _sb = supabase.createClient(SB_URL, SB_KEY);

let currentStatusTab = 1;

// 1. Navigation Logic
function switchTab(viewId, idx) {
    document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    document.getElementById(viewId + '-view').classList.add('active');
    document.querySelectorAll('.nav-item')[idx].classList.add('active');
    
    if(viewId === 'dash') updateDashboardStats();
    if(viewId === 'order') {
        loadOrdersByStatus(currentStatusTab);
        document.getElementById('dot-order').style.display = 'none';
    }
    if(viewId === 'customer') loadCustomers();
}

// 2. Dashboard Stats (Fix: Total Revenue)
async function updateDashboardStats() {
    const { data: allOrders } = await _sb.from('orders').select('total_amount, status');
    
    // Status 3 ဆိုတာ Finished order တွေကိုပဲပေါင်းတာပါ
    const finishedRevenue = allOrders
        .filter(o => o.status == 3)
        .reduce((sum, o) => sum + (parseInt(o.total_amount) || 0), 0);
    
    document.getElementById('st-total-rev').innerText = finishedRevenue.toLocaleString() + " K";
    document.getElementById('st-total-ord').innerText = allOrders.length;
}

// 3. Order Management (Fix: Pending to Finished Flow)
async function loadOrdersByStatus(status, btnElement = null) {
    currentStatusTab = status;
    if(btnElement) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
    }

    const { data, error } = await _sb.from('orders')
        .select('*')
        .eq('status', status)
        .order('created_at', { ascending: false });

    renderOrders(data);
}

function renderOrders(data) {
    const list = document.getElementById('order-list');
    if(!data || data.length === 0) {
        list.innerHTML = "<p style='text-align:center; color:#888;'>No orders found.</p>";
        return;
    }

    list.innerHTML = data.map(o => `
        <div class="order-card" onclick="showVoucherDetail(${JSON.stringify(o).replace(/"/g, '&quot;')})">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <b>${o.customer_name}</b>
                <small style="color:#888;">${new Date(o.created_at).toLocaleTimeString()}</small>
            </div>
            <div style="font-size:13px; color:#555; margin-bottom:10px;">${o.phone}</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b style="color:var(--primary);">${o.total_amount.toLocaleString()} K</b>
                ${renderStatusButton(o)}
            </div>
        </div>
    `).join('');
}

function renderStatusButton(order) {
    if(order.status == 1) return `<button class="btn btn-primary" onclick="event.stopPropagation(); changeStatus(${order.id}, 2)">Cook Now</button>`;
    if(order.status == 2) return `<button class="btn btn-success" onclick="event.stopPropagation(); changeStatus(${order.id}, 3)">Finish</button>`;
    return `<span style="color:var(--success); font-size:12px;"><i class="fas fa-check-circle"></i> Completed</span>`;
}

async function changeStatus(id, newStatus) {
    const { error } = await _sb.from('orders').update({ status: newStatus }).eq('id', id);
    if(!error) loadOrdersByStatus(currentStatusTab);
}

// 4. Voucher Detail (Fix: Reshow Voucher)
function showVoucherDetail(order) {
    const modal = document.getElementById('voucherModal');
    const container = document.getElementById('voucher-data');
    
    container.innerHTML = `
        <p><b>Order ID:</b> #${order.id}</p>
        <p><b>Customer:</b> ${order.customer_name}</p>
        <p><b>Phone:</b> ${order.phone}</p>
        <p><b>Date:</b> ${new Date(order.created_at).toLocaleString()}</p>
        <table class="premium-table">
            <thead><tr><th>Items</th><th>Qty/Price</th></tr></thead>
            <tbody>
                ${order.items_text.split('\n').map(item => `<tr><td>${item}</td></tr>`).join('')}
            </tbody>
        </table>
        <h3 style="text-align:right; color:var(--primary);">Total: ${order.total_amount.toLocaleString()} K</h3>
    `;
    modal.style.display = 'flex';
}

// 5. Universal Search (Fix: Merge Search)
async function universalSearch() {
    const query = document.getElementById('mainSearch').value.toLowerCase();
    if(query.length < 2) return;

    const { data } = await _sb.from('orders')
        .select('*')
        .or(`customer_name.ilike.%${query}%,phone.ilike.%${query}%`);
    
    renderOrders(data);
}

// 6. Push Notifications
function requestNotificationPermission() {
    Notification.requestPermission().then(perm => {
        if(perm === 'granted') alert("Notifications Enabled!");
    });
}

function sendPush(title, body) {
    if(Notification.permission === 'granted') {
        new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' });
    }
    document.getElementById('notiSound').play();
}

// Realtime Listener
_sb.channel('db-changes').on('postgres_changes', { event: 'INSERT', table: 'orders' }, payload => {
    document.getElementById('dot-order').style.display = 'block';
    sendPush("New Order!", `From ${payload.new.customer_name}`);
    updateDashboardStats();
}).subscribe();

function closeModal(id) { document.getElementById(id).style.display = 'none'; }

window.onload = () => { updateDashboardStats(); };
        </script>
</body>
</html>
