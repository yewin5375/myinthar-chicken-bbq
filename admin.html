<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT Roast Admin Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #FF6B35; --accent: #7360F2; --bg: #F4F7FE; --white: #FFFFFF; --text: #2B3674; --gray: #A3AED0; --danger: #FF4D4D; --success: #05CD99; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 120px; }
        .header { background: var(--white); padding: 25px 20px; border-radius: 0 0 30px 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-box { background: var(--white); padding: 20px; border-radius: 20px; border: 1px solid #E9EDF7; }
        .container { padding: 20px; display: none; }
        .container.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .order-tabs, .cat-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 10px 20px; border-radius: 12px; border: none; background: #E9EDF7; color: var(--text); font-weight: 600; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; }
        .item-card { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid #E9EDF7; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .item-img { width: 65px; height: 65px; border-radius: 12px; object-fit: cover; }
        .price-tag { color: var(--primary); font-weight: bold; }
        .fab { position: fixed; bottom: 100px; right: 25px; background: var(--primary); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; z-index: 999; cursor: pointer; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: none; z-index: 2000; align-items: flex-end; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 100%; border-radius: 30px 30px 0 0; padding: 25px; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #eee; z-index: 1001; }
        .nav-item { color: var(--gray); text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

<div id="dashboard-view" class="container active">
    <div class="header">
        <h2 style="margin:0">Dashboard</h2>
        <div id="stock-alert" style="display:none; background: #FFE5E5; color: #D00; padding: 15px; border-radius: 15px; margin-top: 15px; border: 1px solid #FFCCCC; font-size: 13px;">
            <i class="fas fa-exclamation-triangle"></i> <b>Low Stock:</b> <span id="low-stock-items"></span>
        </div>
        <div class="stat-grid">
            <div class="stat-box"><h4>All Revenue</h4><h2 id="st-rev">0 K</h2></div>
            <div class="stat-box"><h4>New Orders</h4><h2 id="st-ord">0</h2></div>
            <div class="stat-box" style="grid-column: span 2; background: #F8F9FF;">
                <h4>Today's Summary</h4>
                <div style="display:flex; justify-content: space-around; padding-top:10px;">
                    <div style="text-align:center;"><small>Orders</small><h3 id="today-orders">0</h3></div>
                    <div style="text-align:center;"><small>Sales</small><h3 id="today-sales">0 K</h3></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="order-view" class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0">Orders</h3>
        <button onclick="clearFinishedOrders()" style="background:none; border:1px solid var(--danger); color:var(--danger); font-size:11px; padding:5px 10px; border-radius:8px;">Clear Finished</button>
    </div>
    <div class="order-tabs">
        <button class="tab-btn active" onclick="filterOrders(1, this)">New (1)</button>
        <button class="tab-btn" onclick="filterOrders(2, this)">Cooking (2)</button>
        <button class="tab-btn" onclick="filterOrders(3, this)">Finished (3)</button>
    </div>
    <div id="order-list"></div>
</div>

<div id="inventory-view" class="container">
    <h3>Menu Items</h3>
    <div class="cat-tabs">
        <button class="tab-btn active" onclick="filterInventory('All', this)">All</button>
        <button class="tab-btn" onclick="filterInventory('Main', this)">Main</button>
        <button class="tab-btn" onclick="filterInventory('Side', this)">Side</button>
        <button class="tab-btn" onclick="filterInventory('Drink', this)">Drinks</button>
    </div>
    <div id="menu-list"></div>
</div>

<div id="message-view" class="container">
    <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; height: 80vh; background: white; border-radius: 20px; overflow: hidden;">
        
        <div style="border-right: 1px solid #eee; overflow-y: auto; background: #f9f9f9;">
            <div style="padding: 10px; font-size: 12px; font-weight: bold; color: var(--gray);">CHATS</div>
            <div id="chat-users-list"></div>
        </div>

        <div id="admin-chat-window" style="display: flex; flex-direction: column; background: white;">
            <div id="active-chat-user" style="padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; font-size: 14px;">
                Customer ကို ရွေးပါ
            </div>
            <div id="admin-chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f4f7fe;">
                </div>
            <div id="admin-chat-input-area" style="padding: 10px; border-top: 1px solid #eee; display: none; gap: 8px;">
                <input type="text" id="admin-reply-input" placeholder="စာပြန်ရန်..." style="flex: 1; border: 1px solid #eee; padding: 10px; border-radius: 20px; outline: none;">
                <button onclick="sendAdminReply()" style="background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>
    

<div class="modal-overlay" id="add-modal" onclick="if(event.target===this) closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="modal-title">Product</h3>
        <input type="file" id="fileInput" hidden accept="image/*" onchange="previewImg(this)">
        <div onclick="document.getElementById('fileInput').click()" style="border:2px dashed #ccc; padding:20px; text-align:center; border-radius:15px; margin-bottom:15px; cursor:pointer;">
            <p id="file-label" style="margin:0; color:var(--gray)">Tap to upload photo</p>
        </div>
        <input type="text" id="m-name" placeholder="Item Name" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #eee;">
        <input type="number" id="m-price" placeholder="Price (K)" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #eee;">
        <input type="number" id="m-stock" placeholder="Stock Quantity" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #eee;">
        <select id="m-cat" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #eee;">
    <option value="အသား">အသား</option>
    <option value="အရိုး">အရိုး</option>
    <option value="ကလီစာ">ကလီစာ</option>
    <option value="အရေခွံ">အရေခွံ</option>
    <option value="အသီးအရွက်">အသီးအရွက်</option>
    <option value="ဥ">ဥ</option>
        </select>
        
        <button class="btn-save" onclick="saveItem()" style="width:100%; background:var(--primary); color:white; border:none; padding:15px; border-radius:12px; font-weight:bold;">Save Product</button>
    </div>
</div>

<div class="fab" onclick="openModal()"><i class="fas fa-plus"></i></div>

<div class="nav-bar">
    <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-line"></i><div style="font-size:10px">Home</div></div>
    <div class="nav-item" onclick="switchTab('order', this)"><i class="fas fa-shopping-cart"></i><div style="font-size:10px">Orders</div></div>
    <div class="nav-item" onclick="switchTab('inventory', this)"><i class="fas fa-list"></i><div style="font-size:10px">Items</div></div>
    <div class="nav-item" onclick="switchTab('message', this)"><i class="fas fa-envelope"></i><div style="font-size:10px">Inbox</div></div>
</div>

<script>
    const SB_URL = "https://iogpnvljnhsxuzzdltpb.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZ3BudmxqbmhzeHV6emRsdHBiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Njc1OTYwNiwiZXhwIjoyMDgyMzM1NjA2fQ.rNXHHO8PKO58ZXR4Eqzi6Bl0vzCIwH24jiwOVwbVPoc";
    const _sb = supabase.createClient(SB_URL, SB_KEY);
    let base64 = "", editId = null;

    // Navigation
    function switchTab(id, el) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id + '-view').classList.add('active');
        el.classList.add('active');
        if(id === 'inventory') loadMenu();
        if(id === 'order') filterOrders(1, document.querySelector('.tab-btn'));
        if(id === 'message') loadInbox();
        if(id === 'dashboard') loadStats();
    }

    // Modal & Image
    function openModal(data = null) {
        editId = data ? data.id : null;
        document.getElementById('m-name').value = data ? data.name : "";
        document.getElementById('m-price').value = data ? data.price : "";
        document.getElementById('m-stock').value = data ? data.stock_qty : "";
        document.getElementById('m-cat').value = data ? data.category : "Main";
        base64 = data ? data.image : "";
        document.getElementById('file-label').innerText = data ? "Image Loaded ✅" : "Tap to upload photo";
        document.getElementById('add-modal').classList.add('active');
    }
    function closeModal() { document.getElementById('add-modal').classList.remove('active'); editId = null; }
    function previewImg(i) {
        const r = new FileReader();
        r.onload = (e) => { base64 = e.target.result; document.getElementById('file-label').innerText = "Selected ✅"; };
        r.readAsDataURL(i.files[0]);
    }

    // Inventory Logic
    async function loadMenu() {
        const { data } = await _sb.from('products').select('*').order('created_at', {ascending:false});
        renderMenuList(data);
    }
    function renderMenuList(data) {
        document.getElementById('menu-list').innerHTML = data.map(i => `
            <div class="item-card" style="${i.stock_qty <= 0 ? 'opacity:0.6;' : ''}">
                <img src="${i.image}" class="item-img" style="width:65px; height:65px; border-radius:10px;">
                <div style="flex:1"><b>${i.name} ${i.stock_qty <= 0 ? '<small style="color:red">(Sold Out)</small>' : ''}</b><br>
                <span class="price-tag">${i.price} K</span><br><small>Stock: ${i.stock_qty}</small></div>
                <div style="display:flex; gap:15px; font-size:18px;">
                    <i class="fas fa-edit" onclick='openModal(${JSON.stringify(i).replace(/'/g, "&apos;")})' style="color:var(--accent)"></i>
                    <i class="fas fa-trash" onclick="delItem(${i.id})" style="color:var(--danger)"></i>
                </div>
            </div>`).join('');
    }
    async function filterInventory(cat, btn) {
        btn.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        let q = _sb.from('products').select('*').order('created_at', {ascending:false});
        if(cat !== 'All') q = q.eq('category', cat);
        const { data } = await q; renderMenuList(data);
    }

    // ပုံကို Resize လုပ်ဖို့ Variable တစ်ခုထားမယ်
let currentBase64 = "";

function previewImg(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                // Canvas သုံးပြီး ပုံကို Resize လုပ်မယ် (Database နေရာမစားအောင်)
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 400; // အကျယ်ကို 400px ပဲထားမယ်
                const scale = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // ထွက်လာတဲ့ Base64 ကို variable ထဲသိမ်း
                currentBase64 = canvas.toDataURL('image/jpeg', 0.7); 
                document.getElementById('file-label').innerText = "Photo Selected ✅";
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

async function saveItem() {
    const name = document.getElementById('m-name').value;
    const price = document.getElementById('m-price').value;
    const stock = document.getElementById('m-stock').value;
    const cat = document.getElementById('m-cat').value;

    if(!name || !price) return alert("အမည်နှင့် ဈေးနှုန်း ဖြည့်ပေးပါ");

    const payload = {
        name: name,
        price: parseInt(price),
        stock_qty: parseInt(stock) || 0,
        category: cat,
        image: currentBase64 // Admin ကတင်လိုက်တဲ့ ပုံကို ပို့မယ်
    };

    const { error } = await _sb.from('products').insert([payload]);

    if(!error) {
        alert("Product သိမ်းဆည်းပြီးပါပြီ");
        closeModal();
        loadInventory(); // List ကို ပြန်ခေါ်မယ်
        currentBase64 = ""; // ပုံကို ပြန်ရှင်းမယ်
    } else {
        alert("Error: " + error.message);
    }
}
    
    async function delItem(id) { if(confirm("Delete?")) { await _sb.from('products').delete().eq('id', id); loadMenu(); loadStats(); } }

    // Order Logic
    async function filterOrders(st, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
        const { data } = await _sb.from('orders').select('*').eq('status', st).order('created_at',{ascending:false});
        document.getElementById('order-list').innerHTML = data.map(o => `
            <div class="item-card" style="flex-direction:column; align-items:flex-start;">
                <div style="display:flex; justify-content:space-between; width:100%;"><b>${o.customer_name}</b><small>${new Date(o.created_at).toLocaleTimeString()}</small></div>
                <div style="font-size:13px; margin:8px 0;">${o.items_text}</div>
                <div style="display:flex; justify-content:space-between; width:100%;">
                    <b class="price-tag">${o.total_amount} K</b>
                    <div>
                        ${st==1 ? `<button onclick="updOrder(${o.id}, 2)" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:8px;">Confirm</button>` : ''}
                        ${st==2 ? `<button onclick="updOrder(${o.id}, 3)" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:8px;">Done</button>` : ''}
                    </div>
                </div>
            </div>`).join('');
    }
    async function updOrder(id, next) { await _sb.from('orders').update({status: next}).eq('id', id); filterOrders(next==2?1:2, document.querySelector('.tab-btn.active')); loadStats(); }
    async function clearFinishedOrders() { if(confirm("Clear all finished orders?")) { await _sb.from('orders').delete().eq('status', 3); filterOrders(1, document.querySelector('.tab-btn')); loadStats(); } }

    // Stats & Messages
    async function loadStats() {
        const { data: ords } = await _sb.from('orders').select('total_amount, created_at');
        const { count: prod } = await _sb.from('products').select('*', {count:'exact', head:true});
        const { count: nOrd } = await _sb.from('orders').select('*', {count:'exact', head:true}).eq('status', 1);
        let rev = 0, tRev = 0, tCnt = 0; const today = new Date().toISOString().split('T')[0];
        if(ords) ords.forEach(o => { let a = parseInt(o.total_amount.toString().replace(/\D/g,''))||0; rev+=a; if(o.created_at.startsWith(today)){ tRev+=a; tCnt++; } });
        document.getElementById('st-rev').innerText = rev.toLocaleString() + " K";
        document.getElementById('st-ord').innerText = nOrd || 0;
        document.getElementById('today-orders').innerText = tCnt;
        document.getElementById('today-sales').innerText = tRev.toLocaleString() + " K";
        
        const { data: low } = await _sb.from('products').select('id, name').lte('stock_qty', 5);
        if(low && low.length > 0) {
            document.getElementById('stock-alert').style.display = 'block';
            document.getElementById('low-stock-items').innerHTML = low.map(l => `${l.name} <a href="#" onclick="quickRefill(${l.id})" style="color:var(--accent); text-decoration:none;">[Refill]</a>`).join(', ');
        } else document.getElementById('stock-alert').style.display = 'none';
    }
    async function quickRefill(id) { let a = prompt("Refill Quantity:"); if(a) { await _sb.from('products').update({stock_qty:parseInt(a)}).eq('id',id); loadStats(); loadMenu(); } }
    async function loadInbox() {
        const { data } = await _sb.from('messages').select('*').order('created_at',{ascending:false});
        document.getElementById('message-list').innerHTML = data.map(m => `<div class="item-card" style="flex-direction:column; align-items:flex-start;"><b>${m.customer_name}</b><p>${m.message_text}</p></div>`).join('');
    }

    let currentChatUserId = null;

// စာပို့ထားတဲ့ လူစာရင်းကို ယူမယ်
async function loadChatUsers() {
    const { data } = await _sb.from('chats').select('customer_id').order('created_at', {ascending: false});
    // Duplicate တွေကို ဖယ်ပြီး Unique User List လုပ်မယ်
    const uniqueUsers = [...new Set(data.map(item => item.customer_id))];
    
    const list = document.getElementById('chat-users-list');
    list.innerHTML = uniqueUsers.map(uid => `
        <div onclick="openAdminChat('${uid}')" style="padding: 15px 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 11px; text-align: center; background: ${currentChatUserId === uid ? '#fff' : 'transparent'}">
            <i class="fas fa-user-circle" style="font-size: 20px; color: var(--gray);"></i><br>
            ${uid.slice(-5)}
        </div>
    `).join('');
}

// တစ်ဦးချင်းစီရဲ့ Chat ကို ဖွင့်မယ်
async function openAdminChat(uid) {
    currentChatUserId = uid;
    document.getElementById('active-chat-user').innerText = "Chatting with: " + uid.slice(-5);
    document.getElementById('admin-chat-input-area').style.display = 'flex';
    
    const { data } = await _sb.from('chats').select('*').eq('customer_id', uid).order('created_at', {ascending: true});
    renderAdminChat(data);
    loadChatUsers(); // List မှာ highlight ပြဖို့
}

function renderAdminChat(data) {
    const box = document.getElementById('admin-chat-messages');
    box.innerHTML = data.map(m => `
        <div style="align-self: ${m.sender === 'admin' ? 'flex-end' : 'flex-start'}; 
                    background: ${m.sender === 'admin' ? 'var(--primary)' : 'white'}; 
                    color: ${m.sender === 'admin' ? 'white' : 'black'}; 
                    padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            ${m.message}
        </div>
    `).join('');
    box.scrollTop = box.scrollHeight;
}

// Admin က ပြန်စာပို့မယ်
async function sendAdminReply() {
    const input = document.getElementById('admin-reply-input');
    const msg = input.value.trim();
    if(!msg || !currentChatUserId) return;

    await _sb.from('chats').insert([{
        customer_id: currentChatUserId,
        sender: 'admin',
        message: msg
    }]);

    input.value = "";
    openAdminChat(currentChatUserId); // Refresh messages
}

// Realtime နားထောင်ခြင်း (Admin ဘက်မှာ Inbox update ဖြစ်ဖို့)
_sb.channel('admin-live-chat').on('postgres_changes', { 
    event: 'INSERT', schema: 'public', table: 'chats' 
}, payload => {
    loadChatUsers();
    if(currentChatUserId === payload.new.customer_id) {
        openAdminChat(currentChatUserId);
    }
}).subscribe();

// Inbox Tab ကို နှိပ်ရင် User List ကို load လုပ်မယ်
// switchTab function ထဲမှာ loadChatUsers(); ကို ထည့်ထားဖို့ မမေ့ပါနဲ့။
    
    window.onload = loadStats;
</script>
</body>
</html>

